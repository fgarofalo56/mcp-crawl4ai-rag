"""Tests for search_strategies module."""

import pytest

pytestmark = pytest.mark.skip(reason="Temporary skip due to openai import conflict")
from unittest.mock import Mock, AsyncMock, patch
from src.search_strategies import (
    SearchResult,
    RAGSearchStrategy,
    CodeSearchStrategy,
    SearchStrategyFactory,
)


class TestSearchResult:
    """Test SearchResult dataclass."""

    def test_creation(self):
        """Test creating search result."""
        result = SearchResult(
            success=True, query="test", results=[{"content": "test"}], result_count=1
        )
        assert result.success is True
        assert result.query == "test"
        assert result.result_count == 1


class TestRAGSearchStrategy:
    """Test RAGSearchStrategy."""

    @pytest.mark.asyncio
    async def test_vector_search(self):
        """Test vector-only search."""
        strategy = RAGSearchStrategy()
        mock_client = Mock()
        mock_results = [{"id": 1, "content": "test", "similarity": 0.9}]

        with patch("src.search_strategies.search_documents", return_value=mock_results):
            result = await strategy.execute_search(mock_client, "query", match_count=5)

        assert result.success is True
        assert result.result_count == 1

    @pytest.mark.asyncio
    async def test_with_reranking(self):
        """Test search with reranking."""
        strategy = RAGSearchStrategy()
        mock_client = Mock()
        mock_results = [{"id": 1, "content": "test", "similarity": 0.8}]
        mock_reranker = Mock()
        mock_reranker.predict.return_value = [0.95]

        with patch("src.search_strategies.search_documents", return_value=mock_results):
            result = await strategy.execute_search(
                mock_client, "query", reranking_model=mock_reranker
            )

        assert result.metadata["reranked"] is True

    @pytest.mark.asyncio
    async def test_error_handling(self):
        """Test error handling."""
        strategy = RAGSearchStrategy()
        mock_client = Mock()

        with patch("src.search_strategies.search_documents", side_effect=Exception("DB error")):
            result = await strategy.execute_search(mock_client, "query")

        assert result.success is False
        assert "DB error" in result.error_message


class TestCodeSearchStrategy:
    """Test CodeSearchStrategy."""

    @pytest.mark.asyncio
    async def test_code_search(self):
        """Test code example search."""
        strategy = CodeSearchStrategy()
        mock_client = Mock()
        mock_results = [{"id": 1, "code": "def test(): pass", "summary": "Test"}]

        with patch("src.search_strategies.search_code_examples", return_value=mock_results):
            result = await strategy.execute_search(mock_client, "test", match_count=5)

        assert result.success is True
        assert result.metadata["search_type"] == "code_examples"


class TestSearchStrategyFactory:
    """Test SearchStrategyFactory."""

    def test_get_rag_strategy(self):
        """Test getting RAG strategy."""
        strategy = SearchStrategyFactory.get_rag_strategy()
        assert isinstance(strategy, RAGSearchStrategy)

    def test_get_code_strategy(self):
        """Test getting code strategy."""
        strategy = SearchStrategyFactory.get_code_strategy()
        assert isinstance(strategy, CodeSearchStrategy)
